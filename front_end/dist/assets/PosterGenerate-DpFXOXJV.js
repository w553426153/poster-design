import{co as e,j as t,bY as a,r as l,c as s,a as i,p as n,s as o,v as r,A as c,Y as u,W as d,B as p,bZ as v,Q as m,X as f,y as h,ab as y,cp as g,cd as b,O as w,q as k,u as _,c8 as U,cq as x,c3 as I,c4 as D,bO as C,ac as E}from"./index-BO0Lm2fY.js";const $=[{url:"https://picsum.photos/seed/product1/600/840",type:"产品类",title:"新品发布海报"},{url:"https://picsum.photos/seed/product2/600/840",type:"产品类",title:"电商促销主图"},{url:"https://picsum.photos/seed/product3/600/840",type:"产品类",title:"数码产品上市"},{url:"https://picsum.photos/seed/product4/600/840",type:"产品类",title:"美妆护肤推广"},{url:"https://picsum.photos/seed/brand1/600/840",type:"品牌类",title:"品牌故事海报"},{url:"https://picsum.photos/seed/brand2/600/840",type:"品牌类",title:"品牌调性大片"},{url:"https://picsum.photos/seed/brand3/600/840",type:"品牌类",title:"品牌周年宣传"},{url:"https://picsum.photos/seed/brand4/600/840",type:"品牌类",title:"品牌形象焕新"},{url:"https://picsum.photos/seed/season1/600/840",type:"节气类",title:"立春节气海报"},{url:"https://picsum.photos/seed/season2/600/840",type:"节气类",title:"夏至清凉促"},{url:"https://picsum.photos/seed/season3/600/840",type:"节气类",title:"秋分插画风"},{url:"https://picsum.photos/seed/season4/600/840",type:"节气类",title:"冬至温暖季"}],R=e=>(I("data-v-315a6b2b"),e=e(),D(),e),A={class:"poster-generate"},V={class:"side-panel"},K=R((()=>r("h2",null,"海报生成助手",-1))),P=R((()=>r("p",{class:"desc"},"选择参考模板或上传图片，帮助 AI 更好理解你的需求。",-1))),q={class:"quota-tip"},L={class:"example-grid"},z=["title","onClick"],O=["src","alt"],S={key:0,class:"pagination"},T={class:"chat-panel"},j={class:"bubble"},F=["src"],M={class:"reference-strip"},Y={class:"strip-head"},B={class:"count"},G=R((()=>r("span",{class:"strip-note"},"引用来自模板，底图来自上传",-1))),H={key:0,class:"reference-list"},Q=["src"],W={class:"chip-info"},X={class:"chip-title"},Z={key:1,class:"reference-empty"},J={class:"chat-input"},N={class:"chat-actions"},ee=E(t({__name:"PosterGenerate",setup(t){var I;const D=(b.API_URL&&b.API_URL.trim().length?b.API_URL:"undefined"!=typeof window?window.location.origin:"").replace(/\/$/,""),E=["产品类","品牌类","节气类"],R=a([{id:crypto.randomUUID(),role:"ai",type:"text",content:"你好，我是海报生成助手。告诉我你的想法或上传参考图，我会给出建议。"}]),ee=l(""),te=l(!1),ae=l(!1),le=l(null),se=l(null),ie=l([]),ne=l(null),oe=a((()=>{const e={"产品类":[],"品牌类":[],"节气类":[]};return $.forEach(((t,a)=>{e[t.type]&&e[t.type].push({id:`${t.type}-${a}`,title:t.title,cover:t.url})})),E.map((t=>({id:t,name:t,examples:e[t]||[]})))})()),re=l((null==(I=oe[0])?void 0:I.id)||"产品类"),ce=a({});oe.forEach((e=>ce[e.id]=1));const ue=s((()=>oe.find((e=>e.id===re.value)))),de=s((()=>ue.value?ce[ue.value.id]:1)),pe=s((()=>{var e;const t=(null==(e=ue.value)?void 0:e.examples)||[];return Math.max(1,Math.ceil(t.length/20))})),ve=s((()=>{const e=ue.value;if(!e)return[];const t=20*(de.value-1);return e.examples.slice(t,t+20)})),me=s((()=>ie.value.length<2)),fe=e=>(R.push(e),C((()=>{var e;null==(e=se.value)||e.scrollTo({top:se.value.scrollHeight,behavior:"smooth"})})),e.id),he=(e,t)=>{const a=R.find((t=>t.id===e));a&&(a.content=t)},ye=()=>!!me.value||(g.warning("引用区最多只能放 2 张图片"),!1),ge=e=>{ie.value.unshift({...e,id:crypto.randomUUID()})},be=()=>{var e;ye()&&(null==(e=le.value)||e.click())},we=async e=>{const t=e.target,a=null==t?void 0:t.files;if(a&&a[0])if(ye()){ae.value=!0;try{const{preview:e,remote:t,fileKey:l}=await Ue(a[0]);ge({src:e,remote:t,title:a[0].name,kind:"base",fileKey:l})}catch(l){g.error(Ee(l))}finally{ae.value=!1,t&&(t.value="")}}else t.value=""},ke=e=>{const t=ue.value;if(!t)return;const a=de.value+e;a>=1&&a<=pe.value&&(ce[t.id]=a)},_e=async()=>{var t;const a=ee.value.trim();if(!a&&!ie.value.length)return void g.warning("请输入内容或选择参考图");if(te.value)return;te.value=!0;const l=ie.value.map((e=>({...e})));try{await $e(l),a&&fe({id:crypto.randomUUID(),role:"user",type:"text",content:a}),l.forEach((e=>{fe({id:crypto.randomUUID(),role:"user",type:"image",content:e.src})}));const s={prompt:a||"根据当前参考图片生成海报",references:l.filter((e=>"reference"===e.kind)).map((e=>e.remote)),base_images:l.filter((e=>"base"===e.kind)).map((e=>e.ossUrl||e.remote))},i=await(t=>e("api/poster/tasks",t,"post",{},{timeout:18e4}))(s);if(0!==i.code)throw new Error(i.message||"任务创建失败");const n=null==(t=i.data)?void 0:t.task_id;if(!n)throw new Error("任务ID缺失");const o=fe({id:crypto.randomUUID(),role:"ai",type:"text",content:"已提交生成任务，正在排队…"});De(n,o)}catch(s){te.value=!1,g.error(Ee(s))}finally{ee.value=""}},Ue=async t=>{const a=new FormData;a.append("file",t);const l=await e("api/files/upload",a,"post");if(!l||"success"!==l.status||!l.file_path)throw new Error((null==l?void 0:l.message)||"上传失败");return{preview:await Ce(t),remote:`${D}/api/files/${l.file_path}`,fileKey:l.file_path}},xe={in_queue:"排队中",generating:"生成中",processing:"生成中",running:"生成中",pending:"排队中"},Ie=()=>{ne.value&&(window.clearTimeout(ne.value),ne.value=null)},De=(t,a)=>{Ie();const l=async()=>{var s,i;try{const n=await(t=>e(`api/poster/tasks/${t}`,{},"get"))(t);if(0!==n.code)throw new Error(n.message||"查询失败");const o=(null==(s=n.data)?void 0:s.status)||"unknown";if(["done","success","finished"].includes(o)){fe({id:crypto.randomUUID(),role:"ai",type:"text",content:"生成完成，已返回预览。"});const e=(null==(i=n.data)?void 0:i.image_urls)||[];return e.length?e.forEach((e=>{fe({id:crypto.randomUUID(),role:"ai",type:"image",content:e})})):fe({id:crypto.randomUUID(),role:"ai",type:"text",content:"任务完成，但暂未获取到图片。"}),te.value=!1,void Ie()}if(["failed","error","timeout"].includes(o))return he(a,"生成失败，请稍后重试。"),te.value=!1,void Ie();he(a,`任务${xe[o]||o}，请稍候…`),ne.value=window.setTimeout(l,5e3)}catch(n){he(a,`查询失败：${Ee(n)}`),te.value=!1,Ie()}};l()},Ce=e=>new Promise(((t,a)=>{const l=new FileReader;l.onload=()=>t(l.result),l.onerror=a,l.readAsDataURL(e)})),Ee=e=>e instanceof Error?e.message:String(e),$e=async t=>{const a=t.filter((e=>"base"===e.kind&&!e.ossUrl&&e.fileKey));if(a.length)for(const l of a){const t=await e("api/files/upload-oss",{file_path:l.fileKey,remote_path:"poster/base"},"post");if(!t||"success"!==t.status||!t.oss_url)throw new Error((null==t?void 0:t.message)||"OSS上传失败");l.ossUrl=t.oss_url;const a=ie.value.find((e=>e.id===l.id));a&&(a.ossUrl=t.oss_url)}};return i((()=>{Ie()})),(e,t)=>{const a=v("el-button"),l=v("el-tab-pane"),s=v("el-tabs"),i=v("el-icon"),g=v("el-input"),b=v("el-tooltip");return o(),n("div",A,[r("aside",V,[K,P,r("div",q,[u(" 引用区："+d(ie.value.length)+"/"+d(2)+" ",1),r("span",null,"引用+底图最多 "+d(2)+" 张")]),c(s,{modelValue:re.value,"onUpdate:modelValue":t[2]||(t[2]=e=>re.value=e),class:"poster-tabs"},{default:p((()=>[(o(!0),n(m,null,f(oe,(e=>(o(),w(l,{key:e.id,name:e.id,label:e.name},{default:p((()=>[r("div",L,[(o(!0),n(m,null,f(ve.value,(e=>(o(),n("div",{key:e.id,class:h(["example-card",{disabled:!me.value}]),title:me.value?"点击引用该模板":"最多只能添加两张图片",onClick:t=>(e=>{ye()&&ge({src:e.cover,remote:e.cover,title:e.title,kind:"reference"})})(e)},[r("img",{src:e.cover,alt:e.title},null,8,O),r("p",null,d(e.title),1)],10,z)))),128))]),pe.value>1?(o(),n("div",S,[c(a,{size:"small",onClick:t[0]||(t[0]=e=>ke(-1)),disabled:de.value<=1},{default:p((()=>[u("上一页")])),_:1},8,["disabled"]),r("span",null,d(de.value)+" / "+d(pe.value),1),c(a,{size:"small",onClick:t[1]||(t[1]=e=>ke(1)),disabled:de.value>=pe.value},{default:p((()=>[u("下一页")])),_:1},8,["disabled"])])):k("",!0)])),_:2},1032,["name","label"])))),128))])),_:1},8,["modelValue"])]),r("section",T,[r("div",{ref_key:"messageContainer",ref:se,class:"messages"},[(o(!0),n(m,null,f(R,(e=>(o(),n("div",{key:e.id,class:h(["message",e.role])},[r("div",j,["text"===e.type?(o(),n(m,{key:0},[u(d(e.content),1)],64)):(o(),n("img",{key:1,src:e.content,alt:"chat image"},null,8,F))])],2)))),128))],512),r("div",M,[r("div",Y,[r("div",null,[u("引用区 "),r("span",B,d(ie.value.length)+"/"+d(2),1)]),G]),ie.value.length?(o(),n("div",H,[(o(!0),n(m,null,f(ie.value,(e=>(o(),n("div",{class:"reference-chip",key:e.id},[r("img",{src:e.src,alt:"reference"},null,8,Q),r("div",W,[r("span",{class:h(["chip-label",e.kind])},d("reference"===e.kind?"引用":"底图"),3),r("span",X,d(e.title||"未命名图片"),1)]),c(i,{class:"chip-close",onClick:y((t=>{return a=e.id,void(ie.value=ie.value.filter((e=>e.id!==a)));var a}),["stop"])},{default:p((()=>[c(_(U))])),_:2},1032,["onClick"])])))),128))])):(o(),n("p",Z,"从左侧模板或上传底图添加图片（最多两张）。"))]),r("div",J,[c(g,{modelValue:ee.value,"onUpdate:modelValue":t[3]||(t[3]=e=>ee.value=e),type:"textarea",autosize:{minRows:2,maxRows:4},placeholder:"描述你想要的海报或提出问题"},null,8,["modelValue"]),r("div",N,[r("input",{ref_key:"imageInput",ref:le,class:"hidden-input",type:"file",accept:"image/*",onChange:we},null,544),c(b,{content:"上传底图",placement:"top"},{default:p((()=>[c(a,{circle:"",text:"",class:"icon-button",loading:ae.value,disabled:ae.value||!me.value,onClick:be},{default:p((()=>[c(i,null,{default:p((()=>[c(_(x))])),_:1})])),_:1},8,["loading","disabled"])])),_:1}),c(a,{type:"primary",onClick:_e,loading:te.value,disabled:te.value||!ee.value&&!ie.value.length},{default:p((()=>[u(" 发送 ")])),_:1},8,["loading","disabled"])])])])])}}}),[["__scopeId","data-v-315a6b2b"]]);export{ee as default};
