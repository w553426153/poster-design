import{co as e,j as t,bY as l,r as a,c as n,a5 as o,a as s,p as i,s as c,v as d,A as r,Y as u,W as v,B as p,bZ as b,Q as m,X as f,y as w,ab as h,cp as y,cd as g,O as E,q as A,u as k,c8 as j,cq as _,c3 as U,c4 as B,c0 as C,bT as x,bO as I,ac as D}from"./index-BaDylMWQ.js";const R=[{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%202.webp",type:"产品类",title:"产品 2"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%2014.webp",type:"产品类",title:"产品 14"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%2018.webp",type:"产品类",title:"产品 18"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E5%93%81%E7%89%8C%201.webp",type:"品牌类",title:"品牌 1"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%2019.webp",type:"产品类",title:"产品 19"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%2015.webp",type:"产品类",title:"产品 15"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%203.webp",type:"产品类",title:"产品 3"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%208.webp",type:"产品类",title:"产品 8"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E8%8A%82%E6%B0%94%201.webp",type:"节气类",title:"节气 1"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E5%93%81%E7%89%8C%207.webp",type:"品牌类",title:"品牌 7"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%204.webp",type:"产品类",title:"产品 4"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%2012.webp",type:"产品类",title:"产品 12"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%2013.webp",type:"产品类",title:"产品 13"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%205.webp",type:"产品类",title:"产品 5"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E5%93%81%E7%89%8C%206.webp",type:"品牌类",title:"品牌 6"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%209.webp",type:"产品类",title:"产品 9"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E5%93%81%E7%89%8C%205.webp",type:"品牌类",title:"品牌 5"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E8%8A%82%E6%B0%94%203.webp",type:"节气类",title:"节气 3"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E5%93%81%E7%89%8C%209.webp",type:"品牌类",title:"品牌 9"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%2010.webp",type:"产品类",title:"产品 10"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%206.webp",type:"产品类",title:"产品 6"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%207.webp",type:"产品类",title:"产品 7"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%2011.webp",type:"产品类",title:"产品 11"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E5%93%81%E7%89%8C%208.webp",type:"品牌类",title:"品牌 8"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E8%8A%82%E6%B0%94%202.webp",type:"节气类",title:"节气 2"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E5%93%81%E7%89%8C%204.webp",type:"品牌类",title:"品牌 4"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%2016.webp",type:"产品类",title:"产品 16"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E5%93%81%E7%89%8C%203.webp",type:"品牌类",title:"品牌 3"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E8%8A%82%E6%B0%94%204.webp",type:"节气类",title:"节气 4"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E5%93%81%E7%89%8C%202.webp",type:"品牌类",title:"品牌 2"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%201.webp",type:"产品类",title:"产品 1"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%2017.webp",type:"产品类",title:"产品 17"}],$=e=>(U("data-v-4207aca4"),e=e(),B(),e),L={class:"poster-generate modal-mode"},O={class:"side-panel"},V=$((()=>d("h2",null,"海报生成助手",-1))),z=$((()=>d("p",{class:"desc"},"选择参考模板或上传图片，帮助 AI 更好理解你的需求。",-1))),K={class:"quota-tip"},P={class:"tab-content-scroll"},S={class:"example-grid"},q=["title","onClick"],T={class:"card-thumb"},H=["src","alt"],F={key:0,class:"pagination"},J={class:"chat-panel"},M={class:"bubble"},N=["src"],W={class:"img-actions"},Y={class:"reference-strip"},G={class:"strip-head"},Q={class:"count"},X=$((()=>d("span",{class:"strip-note"},"引用来自模板，底图来自上传",-1))),Z={key:0,class:"reference-list"},ee=["src"],te={class:"chip-info"},le={class:"chip-title"},ae={key:1,class:"reference-empty"},ne={class:"chat-input"},oe={class:"chat-actions"},se=D(t({__name:"PosterGenerate",setup(t){var U;const B=(g.API_URL&&g.API_URL.trim().length?g.API_URL:"undefined"!=typeof window?window.location.origin:"").replace(/\/$/,""),D=["产品类","品牌类","节气类"],$=l([{id:crypto.randomUUID(),role:"ai",type:"text",content:"你好，我是海报生成助手。告诉我你的想法或上传参考图，我会给出建议。"}]),se=a(""),ie=a(!1),ce=a(!1),de=a(null),re=a(null),ue=a([]),ve=a(null),pe=l((()=>{const e={"产品类":[],"品牌类":[],"节气类":[]};return R.forEach(((t,l)=>{e[t.type]&&e[t.type].push({id:`${t.type}-${l}`,title:t.title,cover:t.url})})),D.map((t=>({id:t,name:t,examples:e[t]||[]})))})()),be=a((null==(U=pe[0])?void 0:U.id)||"产品类"),me=l({});pe.forEach((e=>me[e.id]=1));const fe=n((()=>pe.find((e=>e.id===be.value)))),we=n((()=>fe.value?me[fe.value.id]:1)),he=n((()=>{var e;const t=(null==(e=fe.value)?void 0:e.examples)||[];return Math.max(1,Math.ceil(t.length/20))})),ye=n((()=>{const e=fe.value;if(!e)return[];const t=20*(we.value-1);return e.examples.slice(t,t+20)})),ge=n((()=>ue.value.length<2)),Ee=C(),Ae=o(),ke=e=>($.push(e),I((()=>{var e;null==(e=re.value)||e.scrollTo({top:re.value.scrollHeight,behavior:"smooth"})})),e.id),je=(e,t)=>{const l=$.find((t=>t.id===e));l&&(l.content=t)},_e=()=>!!ge.value||(y.warning("引用区最多只能放 2 张图片"),!1),Ue=e=>{ue.value.unshift({...e,id:crypto.randomUUID()})},Be=()=>{var e;_e()&&(null==(e=de.value)||e.click())},Ce=async e=>{const t=e.target,l=null==t?void 0:t.files;if(l&&l[0])if(_e()){ce.value=!0;try{const{preview:e,remote:t,fileKey:a}=await De(l[0]);Ue({src:e,remote:t,title:l[0].name,kind:"base",fileKey:a})}catch(a){y.error(Ve(a))}finally{ce.value=!1,t&&(t.value="")}}else t.value=""},xe=e=>{const t=fe.value;if(!t)return;const l=we.value+e;l>=1&&l<=he.value&&(me[t.id]=l)},Ie=async()=>{var t,l;const a=se.value.trim();if(!a&&!ue.value.length)return void y.warning("请输入内容或选择参考图");if(ie.value)return;ie.value=!0;const n=ue.value.map((e=>({...e})));try{await ze(n),a&&ke({id:crypto.randomUUID(),role:"user",type:"text",content:a}),n.forEach((e=>{ke({id:crypto.randomUUID(),role:"user",type:"image",content:e.src})}));const o={prompt:a||"根据当前参考图片生成海报",references:n.filter((e=>"reference"===e.kind)).map((e=>e.remote)),base_images:n.filter((e=>"base"===e.kind)).map((e=>e.ossUrl||e.remote))},s=await(t=>e("api/poster/tasks",t,"post",{},{timeout:18e4}))(o);if(!(0===s.code||200===s.code||1===s.stat))throw new Error(s.message||"任务创建失败");const i=(null==(t=s.data)?void 0:t.image_urls)||s.image_urls;if(null==i?void 0:i.length)return ke({id:crypto.randomUUID(),role:"ai",type:"text",content:"生成完成，已返回预览。"}),i.forEach((e=>ke({id:crypto.randomUUID(),role:"ai",type:"image",content:e}))),ie.value=!1,void(ue.value=[]);const c=null==(l=s.data)?void 0:l.task_id;if(!c)throw new Error("任务ID缺失");const d=ke({id:crypto.randomUUID(),role:"ai",type:"text",content:"已提交生成任务，正在排队…"});Le(c,d)}catch(o){ie.value=!1,y.error(Ve(o))}finally{se.value=""}},De=async t=>{const l=new FormData;l.append("file",t);const a=await e("api/files/upload",l,"post");if(!a||"success"!==a.status||!a.file_path)throw new Error((null==a?void 0:a.message)||"上传失败");return{preview:await Oe(t),remote:`${B}/api/files/${a.file_path}`,fileKey:a.file_path}},Re={in_queue:"排队中",generating:"生成中",processing:"生成中",running:"生成中",pending:"排队中"},$e=()=>{ve.value&&(window.clearTimeout(ve.value),ve.value=null)},Le=(t,l)=>{$e();const a=async()=>{var n,o;try{const s=await(t=>e(`api/poster/tasks/${t}`,{},"get"))(t);if(0!==s.code)throw new Error(s.message||"查询失败");const i=(null==(n=s.data)?void 0:n.status)||"unknown";if(["done","success","finished"].includes(i)){je(l,"生成完成，已返回预览。");const e=(null==(o=s.data)?void 0:o.image_urls)||[];return e.length?e.forEach((e=>{ke({id:crypto.randomUUID(),role:"ai",type:"image",content:e})})):ke({id:crypto.randomUUID(),role:"ai",type:"text",content:"任务完成，但暂未获取到图片。"}),ie.value=!1,ue.value=[],void $e()}if(["failed","error","timeout"].includes(i))return je(l,"生成失败，请稍后重试。"),ie.value=!1,void $e();je(l,`任务${Re[i]||i}，请稍候…`),ve.value=window.setTimeout(a,5e3)}catch(s){je(l,`查询失败：${Ve(s)}`),ie.value=!1,$e()}};a()},Oe=e=>new Promise(((t,l)=>{const a=new FileReader;a.onload=()=>t(a.result),a.onerror=l,a.readAsDataURL(e)})),Ve=e=>e instanceof Error?e.message:String(e),ze=async t=>{const l=t.filter((e=>"base"===e.kind&&!e.ossUrl&&e.fileKey));if(l.length)for(const a of l){const t=await e("api/files/upload-oss",{file_path:a.fileKey,remote_path:"poster/base"},"post");if(!t||"success"!==t.status||!t.oss_url)throw new Error((null==t?void 0:t.message)||"OSS上传失败");a.ossUrl=t.oss_url;const l=ue.value.find((e=>e.id===a.id));l&&(l.ossUrl=t.oss_url)}};return s((()=>{$e()})),(e,t)=>{const l=b("el-button"),a=b("el-tab-pane"),n=b("el-tabs"),o=b("el-icon"),s=b("el-input"),g=b("el-tooltip");return c(),i("div",L,[d("aside",O,[V,z,d("div",K,[u(" 引用区："+v(ue.value.length)+"/"+v(2)+" ",1),d("span",null,"引用+底图最多 "+v(2)+" 张")]),r(n,{modelValue:be.value,"onUpdate:modelValue":t[2]||(t[2]=e=>be.value=e),class:"poster-tabs"},{default:p((()=>[(c(!0),i(m,null,f(pe,(e=>(c(),E(a,{key:e.id,name:e.id,label:e.name},{default:p((()=>[d("div",P,[d("div",S,[(c(!0),i(m,null,f(ye.value,(e=>(c(),i("div",{key:e.id,class:w(["example-card",{disabled:!ge.value}]),title:ge.value?"点击引用该模板":"最多只能添加两张图片",onClick:t=>(e=>{_e()&&Ue({src:e.cover,remote:e.cover,title:e.title,kind:"reference"})})(e)},[d("div",T,[d("img",{src:e.cover,alt:e.title},null,8,H)]),d("p",null,v(e.title),1)],10,q)))),128))]),he.value>1?(c(),i("div",F,[r(l,{size:"small",onClick:t[0]||(t[0]=e=>xe(-1)),disabled:we.value<=1},{default:p((()=>[u("上一页")])),_:1},8,["disabled"]),d("span",null,v(we.value)+" / "+v(he.value),1),r(l,{size:"small",onClick:t[1]||(t[1]=e=>xe(1)),disabled:we.value>=he.value},{default:p((()=>[u("下一页")])),_:1},8,["disabled"])])):A("",!0)])])),_:2},1032,["name","label"])))),128))])),_:1},8,["modelValue"])]),d("section",J,[d("div",{ref_key:"messageContainer",ref:re,class:"messages"},[(c(!0),i(m,null,f($,(e=>(c(),i("div",{key:e.id,class:w(["message",e.role])},[d("div",M,["text"===e.type?(c(),i(m,{key:0},[u(v(e.content),1)],64)):(c(),i(m,{key:1},[d("img",{src:e.content,alt:"chat image"},null,8,N),d("div",W,[r(l,{text:"",size:"small",onClick:t=>(async e=>{try{const t=await fetch(e),l=await t.blob(),a=document.createElement("a");a.href=URL.createObjectURL(l),a.download=`poster-${Date.now()}.png`,a.click(),URL.revokeObjectURL(a.href)}catch(t){y.error(Ve(t))}})(e.content)},{default:p((()=>[u("下载")])),_:2},1032,["onClick"]),r(l,{text:"",type:"primary",size:"small",onClick:t=>(async e=>{"Home"!==Ee.currentRoute.value.name&&Ee.push({name:"Home"});const t=new Image;t.crossOrigin="anonymous",t.src=e,t.onload=()=>{const l=JSON.parse(JSON.stringify(x));l.url=e,l.width=t.width,l.height=t.height,Ae.addWidget(l),y.success("已添加到画布")},t.onerror=()=>y.error("加载图片失败")})(e.content)},{default:p((()=>[u("添加到画布")])),_:2},1032,["onClick"])])],64))])],2)))),128))],512),d("div",Y,[d("div",G,[d("div",null,[u("引用区 "),d("span",Q,v(ue.value.length)+"/"+v(2),1)]),X]),ue.value.length?(c(),i("div",Z,[(c(!0),i(m,null,f(ue.value,(e=>(c(),i("div",{class:"reference-chip",key:e.id},[d("img",{src:e.src,alt:"reference"},null,8,ee),d("div",te,[d("span",{class:w(["chip-label",e.kind])},v("reference"===e.kind?"引用":"底图"),3),d("span",le,v(e.title||"未命名图片"),1)]),r(o,{class:"chip-close",onClick:h((t=>{return l=e.id,void(ue.value=ue.value.filter((e=>e.id!==l)));var l}),["stop"])},{default:p((()=>[r(k(j))])),_:2},1032,["onClick"])])))),128))])):(c(),i("p",ae,"从左侧模板或上传底图添加图片（最多两张）。"))]),d("div",ne,[r(s,{modelValue:se.value,"onUpdate:modelValue":t[3]||(t[3]=e=>se.value=e),type:"textarea",autosize:{minRows:2,maxRows:4},placeholder:"描述你想要的海报或提出问题"},null,8,["modelValue"]),d("div",oe,[d("input",{ref_key:"imageInput",ref:de,class:"hidden-input",type:"file",accept:"image/*",onChange:Ce},null,544),r(g,{content:"上传底图",placement:"top"},{default:p((()=>[r(l,{circle:"",text:"",class:"icon-button",loading:ce.value,disabled:ce.value||!ge.value,onClick:Be},{default:p((()=>[r(o,null,{default:p((()=>[r(k(_))])),_:1})])),_:1},8,["loading","disabled"])])),_:1}),r(l,{type:"primary",onClick:Ie,loading:ie.value,disabled:ie.value||!se.value&&!ue.value.length},{default:p((()=>[u(" 发送 ")])),_:1},8,["loading","disabled"])])])])])}}}),[["__scopeId","data-v-4207aca4"]]);export{se as default};
