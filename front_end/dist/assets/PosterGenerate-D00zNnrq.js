import{co as e,j as t,bY as l,r as a,c as n,w as o,a5 as s,a as i,p as d,s as c,v as r,A as u,Y as v,W as p,B as m,bZ as b,q as f,Q as h,X as w,y as g,ab as y,cp as E,cd as A,O as k,u as _,c8 as j,cq as U,c3 as x,c4 as C,c0 as B,bT as I,bS as V,bO as D,ac as $}from"./index-CgHpowZ8.js";const z=[{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%202.webp",type:"产品类",title:"产品 2"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%2014.webp",type:"产品类",title:"产品 14"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%2018.webp",type:"产品类",title:"产品 18"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E5%93%81%E7%89%8C%201.webp",type:"品牌类",title:"品牌 1"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%2019.webp",type:"产品类",title:"产品 19"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%2015.webp",type:"产品类",title:"产品 15"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%203.webp",type:"产品类",title:"产品 3"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%208.webp",type:"产品类",title:"产品 8"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E8%8A%82%E6%B0%94%201.webp",type:"节气类",title:"节气 1"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E5%93%81%E7%89%8C%207.webp",type:"品牌类",title:"品牌 7"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%204.webp",type:"产品类",title:"产品 4"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%2012.webp",type:"产品类",title:"产品 12"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%2013.webp",type:"产品类",title:"产品 13"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%205.webp",type:"产品类",title:"产品 5"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E5%93%81%E7%89%8C%206.webp",type:"品牌类",title:"品牌 6"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%209.webp",type:"产品类",title:"产品 9"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E5%93%81%E7%89%8C%205.webp",type:"品牌类",title:"品牌 5"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E8%8A%82%E6%B0%94%203.webp",type:"节气类",title:"节气 3"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E5%93%81%E7%89%8C%209.webp",type:"品牌类",title:"品牌 9"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%2010.webp",type:"产品类",title:"产品 10"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%206.webp",type:"产品类",title:"产品 6"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%207.webp",type:"产品类",title:"产品 7"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%2011.webp",type:"产品类",title:"产品 11"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E5%93%81%E7%89%8C%208.webp",type:"品牌类",title:"品牌 8"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E8%8A%82%E6%B0%94%202.webp",type:"节气类",title:"节气 2"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E5%93%81%E7%89%8C%204.webp",type:"品牌类",title:"品牌 4"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%2016.webp",type:"产品类",title:"产品 16"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E5%93%81%E7%89%8C%203.webp",type:"品牌类",title:"品牌 3"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E8%8A%82%E6%B0%94%204.webp",type:"节气类",title:"节气 4"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E5%93%81%E7%89%8C%202.webp",type:"品牌类",title:"品牌 2"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%201.webp",type:"产品类",title:"产品 1"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%2017.webp",type:"产品类",title:"产品 17"}],R=e=>(x("data-v-e26e5d5a"),e=e(),C(),e),L={class:"poster-generate modal-mode"},O={class:"side-panel"},P=R((()=>r("h2",null,"海报生成助手",-1))),S=R((()=>r("p",{class:"desc"},"选择参考模板或上传图片，帮助 AI 更好理解你的需求。",-1))),K={class:"quota-tip"},T={class:"tab-content-scroll"},q={class:"example-grid"},H=["title","onClick"],F=["src","alt"],G={key:0,class:"pagination"},J={class:"chat-panel"},M={class:"bubble"},N=["src"],W={class:"img-actions"},Y={key:0,class:"reference-strip"},Q={class:"strip-head"},X={class:"count"},Z=R((()=>r("span",{class:"strip-note"},"引用来自模板，底图来自上传",-1))),ee={key:0,class:"reference-list"},te=["src"],le={class:"chip-info"},ae={class:"chip-title"},ne={key:1,class:"reference-empty"},oe={class:"chat-input"},se={class:"mode-toolbar inside"},ie=R((()=>r("div",{class:"mode-title"},"模式",-1))),de={key:0,class:"format-summary"},ce={class:"summary-pill"},re={class:"pill-ratio"},ue=R((()=>r("span",{class:"pill-divider"},null,-1))),ve={class:"pill-size"},pe={class:"format-panel"},me={class:"format-section"},be=R((()=>r("p",null,"选择比例",-1))),fe={class:"ratio-options"},he={class:"format-section size-inputs"},we=R((()=>r("p",null,"尺寸 (px)",-1))),ge={class:"size-row"},ye=R((()=>r("span",null,"×",-1))),Ee={key:1,class:"upload-toolbar"},Ae={class:"input-area"},ke={class:"chat-actions"},_e=$(t({__name:"PosterGenerate",setup(t){var x;const C=(A.API_URL&&A.API_URL.trim().length?A.API_URL:"undefined"!=typeof window?window.location.origin:"").replace(/\/$/,""),$=["产品类","品牌类","节气类"],R=l([{id:crypto.randomUUID(),role:"ai",type:"text",content:"你好，我是海报生成助手。告诉我你的想法或上传参考图，我会给出建议。"}]),_e=a(""),je=[{label:"文生图",value:"text"},{label:"参考图生成",value:"reference"},{label:"艺术字生成",value:"art"}],Ue=a("text"),xe=["21:9","16:9","3:2","4:3","1:1","3:4","2:3","9:16"],Ce={"1:1":{width:2048,height:2048},"4:3":{width:2304,height:1728},"3:2":{width:2496,height:1664},"16:9":{width:2560,height:1440},"21:9":{width:3024,height:1296}},Be=l({ratio:"16:9",width:1024,height:768}),Ie=a(!1),Ve=a(!1),De=a(null),$e=a(null),ze=a([]),Re=a(null),Le=l((()=>{const e={"产品类":[],"品牌类":[],"节气类":[]};return z.forEach(((t,l)=>{e[t.type]&&e[t.type].push({id:`${t.type}-${l}`,title:t.title,cover:t.url})})),$.map((t=>({id:t,name:t,examples:e[t]||[]})))})()),Oe=a((null==(x=Le[0])?void 0:x.id)||"产品类"),Pe=l({});Le.forEach((e=>Pe[e.id]=1));const Se=n((()=>Le.find((e=>e.id===Oe.value)))),Ke=n((()=>Se.value?Pe[Se.value.id]:1)),Te=n((()=>{var e;const t=(null==(e=Se.value)?void 0:e.examples)||[];return Math.max(1,Math.ceil(t.length/8))})),qe=n((()=>{const e=Se.value;if(!e)return[];const t=8*(Ke.value-1);return e.examples.slice(t,t+8)})),He=n((()=>ze.value.length<2)),Fe=n((()=>{const e=_e.value.trim();return"reference"===Ue.value?!(!e&&!ze.value.length):!!e}));o(Ue,(e=>{"reference"!==e&&(ze.value=[])}));const Ge=n((()=>`${Be.width}×${Be.height}px`)),Je=B(),Me=s(),Ne=e=>(R.push(e),D((()=>{var e;null==(e=$e.value)||e.scrollTo({top:$e.value.scrollHeight,behavior:"smooth"})})),e.id),We=(e,t)=>{const l=R.find((t=>t.id===e));l&&(l.content=t)},Ye=()=>!!He.value||(E.warning("引用区最多只能放 2 张图片"),!1),Qe=e=>{ze.value.unshift({...e,id:crypto.randomUUID()}),ze.value=ze.value.slice(0,2)},Xe=()=>{var e;Ye()&&(null==(e=De.value)||e.click())},Ze=async e=>{const t=e.target,l=null==t?void 0:t.files;if(l&&l[0])if(Ye()){Ve.value=!0;try{const{preview:e,remote:t,fileKey:a}=await lt(l[0]),n=ze.value.some((e=>"template"===e.source)),o="reference"===Ue.value&&n?"base":"reference";Qe({src:e,remote:t,title:l[0].name,kind:o,fileKey:a,source:"upload"})}catch(a){E.error(it(a))}finally{Ve.value=!1,t&&(t.value="")}}else t.value=""},et=e=>{const t=Se.value;if(!t)return;const l=Ke.value+e;l>=1&&l<=Te.value&&(Pe[t.id]=l)},tt=async()=>{var t,l;const a=_e.value.trim();if(!a&&!ze.value.length)return void E.warning("请输入内容或选择参考图");if(Ie.value)return;Ie.value=!0;const n=ze.value.map((e=>({...e})));try{await dt(n),a&&Ne({id:crypto.randomUUID(),role:"user",type:"text",content:a}),n.forEach((e=>{Ne({id:crypto.randomUUID(),role:"user",type:"image",content:e.src})}));const o={prompt:a||"根据当前参考图片生成海报",references:n.filter((e=>"reference"===e.kind)).map((e=>e.remote)),base_images:n.filter((e=>"base"===e.kind)).map((e=>e.ossUrl||e.remote))},s=await(t=>e("api/poster/tasks",t,"post",{},{timeout:18e4}))(o);if(!(0===s.code||200===s.code||1===s.stat))throw new Error(s.message||"任务创建失败");const i=(null==(t=s.data)?void 0:t.image_urls)||s.image_urls;if(null==i?void 0:i.length)return Ne({id:crypto.randomUUID(),role:"ai",type:"text",content:"生成完成，已返回预览。"}),i.forEach((e=>Ne({id:crypto.randomUUID(),role:"ai",type:"image",content:e}))),Ie.value=!1,void(ze.value=[]);const d=null==(l=s.data)?void 0:l.task_id;if(!d)throw new Error("任务ID缺失");const c=Ne({id:crypto.randomUUID(),role:"ai",type:"text",content:"已提交生成任务，正在排队…"});ot(d,c)}catch(o){Ie.value=!1,E.error(it(o))}finally{_e.value=""}},lt=async t=>{const l=new FormData;l.append("file",t);const a=await e("api/files/upload",l,"post");if(!a||"success"!==a.status||!a.file_path)throw new Error((null==a?void 0:a.message)||"上传失败");return{preview:await st(t),remote:`${C}/api/files/${a.file_path}`,fileKey:a.file_path}},at={in_queue:"排队中",generating:"生成中",processing:"生成中",running:"生成中",pending:"排队中"},nt=()=>{Re.value&&(window.clearTimeout(Re.value),Re.value=null)},ot=(t,l)=>{nt();const a=async()=>{var n,o;try{const s=await(t=>e(`api/poster/tasks/${t}`,{},"get"))(t);if(0!==s.code)throw new Error(s.message||"查询失败");const i=(null==(n=s.data)?void 0:n.status)||"unknown";if(["done","success","finished"].includes(i)){We(l,"生成完成，已返回预览。");const e=(null==(o=s.data)?void 0:o.image_urls)||[];return e.length?e.forEach((e=>{Ne({id:crypto.randomUUID(),role:"ai",type:"image",content:e})})):Ne({id:crypto.randomUUID(),role:"ai",type:"text",content:"任务完成，但暂未获取到图片。"}),Ie.value=!1,ze.value=[],void nt()}if(["failed","error","timeout"].includes(i))return We(l,"生成失败，请稍后重试。"),Ie.value=!1,void nt();We(l,`任务${at[i]||i}，请稍候…`),Re.value=window.setTimeout(a,5e3)}catch(s){We(l,`查询失败：${it(s)}`),Ie.value=!1,nt()}};a()},st=e=>new Promise(((t,l)=>{const a=new FileReader;a.onload=()=>t(a.result),a.onerror=l,a.readAsDataURL(e)})),it=e=>e instanceof Error?e.message:String(e),dt=async t=>{const l=t.filter((e=>"base"===e.kind&&!e.ossUrl&&e.fileKey));if(l.length)for(const a of l){const t=await e("api/files/upload-oss",{file_path:a.fileKey,remote_path:"poster/base"},"post");if(!t||"success"!==t.status||!t.oss_url)throw new Error((null==t?void 0:t.message)||"OSS上传失败");a.ossUrl=t.oss_url;const l=ze.value.find((e=>e.id===a.id));l&&(l.ossUrl=t.oss_url)}};return i((()=>{nt()})),(e,t)=>{const l=b("el-button"),a=b("el-tab-pane"),n=b("el-tabs"),o=b("el-icon"),s=b("el-option"),i=b("el-select"),A=b("el-input-number"),x=b("el-popover"),C=b("el-tooltip"),B=b("el-input");return c(),d("div",L,[r("aside",O,[P,S,r("div",K,[v(" 引用区："+p(ze.value.length)+"/"+p(2)+" ",1),r("span",null,"引用+底图最多 "+p(2)+" 张")]),u(n,{modelValue:Oe.value,"onUpdate:modelValue":t[2]||(t[2]=e=>Oe.value=e),class:"poster-tabs"},{default:m((()=>[(c(!0),d(h,null,w(Le,(e=>(c(),k(a,{key:e.id,name:e.id,label:e.name},{default:m((()=>[r("div",T,[r("div",q,[(c(!0),d(h,null,w(qe.value,(e=>(c(),d("div",{key:e.id,class:g(["example-card",{disabled:!He.value}]),title:He.value?"点击引用该模板":"最多只能添加两张图片",onClick:t=>(e=>{if(!Ye())return;if("reference"!==Ue.value)return void E.warning("此模式下不需要参考图，请切换到参考图生成");ze.value.some((e=>"template"===e.source))?E.warning("模板参考图只能选择一张，请上传底图"):Qe({src:e.cover,remote:e.cover,title:e.title,kind:"reference",source:"template"})})(e)},[r("img",{src:e.cover,alt:e.title},null,8,F),r("p",null,p(e.title),1)],10,H)))),128))]),Te.value>1?(c(),d("div",G,[u(l,{size:"small",onClick:t[0]||(t[0]=e=>et(-1)),disabled:Ke.value<=1},{default:m((()=>[v("上一页")])),_:1},8,["disabled"]),r("span",null,p(Ke.value)+" / "+p(Te.value),1),u(l,{size:"small",onClick:t[1]||(t[1]=e=>et(1)),disabled:Ke.value>=Te.value},{default:m((()=>[v("下一页")])),_:1},8,["disabled"])])):f("",!0)])])),_:2},1032,["name","label"])))),128))])),_:1},8,["modelValue"])]),r("section",J,[r("div",{ref_key:"messageContainer",ref:$e,class:"messages"},[(c(!0),d(h,null,w(R,(e=>(c(),d("div",{key:e.id,class:g(["message",e.role])},[r("div",M,["text"===e.type?(c(),d(h,{key:0},[v(p(e.content),1)],64)):(c(),d(h,{key:1},[r("img",{src:e.content,alt:"chat image"},null,8,N),r("div",W,[u(l,{text:"",size:"small",onClick:t=>(async e=>{try{const t=await fetch(e),l=await t.blob(),a=document.createElement("a");a.href=URL.createObjectURL(l),a.download=`poster-${Date.now()}.png`,a.click(),URL.revokeObjectURL(a.href)}catch(t){E.error(it(t))}})(e.content)},{default:m((()=>[v("下载")])),_:2},1032,["onClick"]),u(l,{text:"",type:"primary",size:"small",onClick:t=>(async e=>{"Home"!==Je.currentRoute.value.name&&await Je.push({name:"Home"});const t=new Image;t.crossOrigin="anonymous",t.src=e,t.onload=()=>{const l=JSON.parse(JSON.stringify(I));l.url=e,l.imgUrl=e,l.width=t.width,l.height=t.height,Me.addWidget(l,{toTop:!0}),V.emit("closePosterGenerate"),E.success("已添加到画布")},t.onerror=()=>E.error("加载图片失败")})(e.content)},{default:m((()=>[v("添加到画布")])),_:2},1032,["onClick"])])],64))])],2)))),128))],512),"reference"===Ue.value?(c(),d("div",Y,[r("div",Q,[r("div",null,[v("引用区 "),r("span",X,p(ze.value.length)+"/"+p(2),1)]),Z]),ze.value.length?(c(),d("div",ee,[(c(!0),d(h,null,w(ze.value,(e=>(c(),d("div",{class:"reference-chip",key:e.id},[r("img",{src:e.src,alt:"reference"},null,8,te),r("div",le,[r("span",{class:g(["chip-label",e.kind])},p("reference"===e.kind?"引用":"底图"),3),r("span",ae,p(e.title||"未命名图片"),1)]),u(o,{class:"chip-close",onClick:y((t=>{return l=e.id,void(ze.value=ze.value.filter((e=>e.id!==l)));var l}),["stop"])},{default:m((()=>[u(_(j))])),_:2},1032,["onClick"])])))),128))])):(c(),d("p",ne,"从左侧模板或上传底图添加图片（最多两张）。"))])):f("",!0),r("div",oe,[r("div",se,[ie,u(i,{modelValue:Ue.value,"onUpdate:modelValue":t[3]||(t[3]=e=>Ue.value=e),size:"small",class:"mode-select"},{default:m((()=>[(c(),d(h,null,w(je,(e=>u(s,{key:e.value,label:e.label,value:e.value},null,8,["label","value"]))),64))])),_:1},8,["modelValue"])]),"text"===Ue.value?(c(),d("div",de,[u(x,{placement:"bottom-start",trigger:"click",width:"360"},{reference:m((()=>[r("button",ce,[r("span",re,p(Be.ratio),1),ue,r("span",ve,p(Ge.value),1)])])),default:m((()=>[r("div",pe,[r("div",me,[be,r("div",fe,[(c(),d(h,null,w(xe,(e=>u(l,{key:e,size:"small",type:e===Be.ratio?"primary":"default",onClick:t=>(e=>{Be.ratio=e,Ce[e]&&(Be.width=Ce[e].width,Be.height=Ce[e].height)})(e)},{default:m((()=>[v(p(e),1)])),_:2},1032,["type","onClick"]))),64))])]),r("div",he,[we,r("div",ge,[u(A,{modelValue:Be.width,"onUpdate:modelValue":t[4]||(t[4]=e=>Be.width=e),min:256,max:4096},null,8,["modelValue"]),ye,u(A,{modelValue:Be.height,"onUpdate:modelValue":t[5]||(t[5]=e=>Be.height=e),min:256,max:4096},null,8,["modelValue"])])])])])),_:1})])):f("",!0),"reference"===Ue.value?(c(),d("div",Ee,[u(C,{content:"上传底图/参考图",placement:"top"},{default:m((()=>[u(l,{text:"",loading:Ve.value,disabled:Ve.value||!He.value,onClick:Xe},{default:m((()=>[u(o,null,{default:m((()=>[u(_(U))])),_:1}),v(" 上传图片 ")])),_:1},8,["loading","disabled"])])),_:1})])):f("",!0),r("div",Ae,[u(B,{modelValue:_e.value,"onUpdate:modelValue":t[6]||(t[6]=e=>_e.value=e),type:"textarea",rows:3,class:"fixed-textarea",resize:"none",placeholder:"art"===Ue.value?"描述你想生成的艺术字效果":"描述你想要的海报或提出问题"},null,8,["modelValue","placeholder"])]),r("div",ke,[r("input",{ref_key:"imageInput",ref:De,class:"hidden-input",type:"file",accept:"image/*",onChange:Ze},null,544),u(l,{type:"primary",onClick:tt,loading:Ie.value,disabled:Ie.value||!Fe.value},{default:m((()=>[v(" 发送 ")])),_:1},8,["loading","disabled"])])])])])}}}),[["__scopeId","data-v-e26e5d5a"]]);export{_e as default};
