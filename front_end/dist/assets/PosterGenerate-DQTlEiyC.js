import{co as e,j as t,bY as l,r as n,c as a,a as o,p as s,s as i,v as d,A as c,Y as r,W as u,B as v,bZ as p,Q as b,X as f,y as m,ab as w,cp as y,cd as g,O as h,q as E,u as A,c8 as j,cq as _,c3 as k,c4 as U,bO as B,ac as C}from"./index-CfHM-FFC.js";const x=[{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%202.webp",type:"产品类",title:"产品 2"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%2014.webp",type:"产品类",title:"产品 14"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%2018.webp",type:"产品类",title:"产品 18"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E5%93%81%E7%89%8C%201.webp",type:"品牌类",title:"品牌 1"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%2019.webp",type:"产品类",title:"产品 19"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%2015.webp",type:"产品类",title:"产品 15"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%203.webp",type:"产品类",title:"产品 3"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%208.webp",type:"产品类",title:"产品 8"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E8%8A%82%E6%B0%94%201.webp",type:"节气类",title:"节气 1"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E5%93%81%E7%89%8C%207.webp",type:"品牌类",title:"品牌 7"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%204.webp",type:"产品类",title:"产品 4"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%2012.webp",type:"产品类",title:"产品 12"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%2013.webp",type:"产品类",title:"产品 13"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%205.webp",type:"产品类",title:"产品 5"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E5%93%81%E7%89%8C%206.webp",type:"品牌类",title:"品牌 6"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%209.webp",type:"产品类",title:"产品 9"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E5%93%81%E7%89%8C%205.webp",type:"品牌类",title:"品牌 5"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E8%8A%82%E6%B0%94%203.webp",type:"节气类",title:"节气 3"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E5%93%81%E7%89%8C%209.webp",type:"品牌类",title:"品牌 9"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%2010.webp",type:"产品类",title:"产品 10"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%206.webp",type:"产品类",title:"产品 6"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%207.webp",type:"产品类",title:"产品 7"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%2011.webp",type:"产品类",title:"产品 11"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E5%93%81%E7%89%8C%208.webp",type:"品牌类",title:"品牌 8"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E8%8A%82%E6%B0%94%202.webp",type:"节气类",title:"节气 2"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E5%93%81%E7%89%8C%204.webp",type:"品牌类",title:"品牌 4"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%2016.webp",type:"产品类",title:"产品 16"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E5%93%81%E7%89%8C%203.webp",type:"品牌类",title:"品牌 3"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E8%8A%82%E6%B0%94%204.webp",type:"节气类",title:"节气 4"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E5%93%81%E7%89%8C%202.webp",type:"品牌类",title:"品牌 2"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%201.webp",type:"产品类",title:"产品 1"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%2017.webp",type:"产品类",title:"产品 17"}],I=e=>(k("data-v-77bfbfb6"),e=e(),U(),e),D={class:"poster-generate"},$={class:"side-panel"},R=I((()=>d("h2",null,"海报生成助手",-1))),V=I((()=>d("p",{class:"desc"},"选择参考模板或上传图片，帮助 AI 更好理解你的需求。",-1))),K={class:"quota-tip"},P={class:"example-grid"},q=["title","onClick"],L=["src","alt"],z={key:0,class:"pagination"},O={class:"chat-panel"},S={class:"bubble"},T=["src"],F={class:"reference-strip"},M={class:"strip-head"},Y={class:"count"},G=I((()=>d("span",{class:"strip-note"},"引用来自模板，底图来自上传",-1))),H={key:0,class:"reference-list"},Q=["src"],W={class:"chip-info"},X={class:"chip-title"},Z={key:1,class:"reference-empty"},J={class:"chat-input"},N={class:"chat-actions"},ee=C(t({__name:"PosterGenerate",setup(t){var k;const U=(g.API_URL&&g.API_URL.trim().length?g.API_URL:"undefined"!=typeof window?window.location.origin:"").replace(/\/$/,""),C=["产品类","品牌类","节气类"],I=l([{id:crypto.randomUUID(),role:"ai",type:"text",content:"你好，我是海报生成助手。告诉我你的想法或上传参考图，我会给出建议。"}]),ee=n(""),te=n(!1),le=n(!1),ne=n(null),ae=n(null),oe=n([]),se=n(null),ie=l((()=>{const e={"产品类":[],"品牌类":[],"节气类":[]};return x.forEach(((t,l)=>{e[t.type]&&e[t.type].push({id:`${t.type}-${l}`,title:t.title,cover:t.url})})),C.map((t=>({id:t,name:t,examples:e[t]||[]})))})()),de=n((null==(k=ie[0])?void 0:k.id)||"产品类"),ce=l({});ie.forEach((e=>ce[e.id]=1));const re=a((()=>ie.find((e=>e.id===de.value)))),ue=a((()=>re.value?ce[re.value.id]:1)),ve=a((()=>{var e;const t=(null==(e=re.value)?void 0:e.examples)||[];return Math.max(1,Math.ceil(t.length/20))})),pe=a((()=>{const e=re.value;if(!e)return[];const t=20*(ue.value-1);return e.examples.slice(t,t+20)})),be=a((()=>oe.value.length<2)),fe=e=>(I.push(e),B((()=>{var e;null==(e=ae.value)||e.scrollTo({top:ae.value.scrollHeight,behavior:"smooth"})})),e.id),me=(e,t)=>{const l=I.find((t=>t.id===e));l&&(l.content=t)},we=()=>!!be.value||(y.warning("引用区最多只能放 2 张图片"),!1),ye=e=>{oe.value.unshift({...e,id:crypto.randomUUID()})},ge=()=>{var e;we()&&(null==(e=ne.value)||e.click())},he=async e=>{const t=e.target,l=null==t?void 0:t.files;if(l&&l[0])if(we()){le.value=!0;try{const{preview:e,remote:t,fileKey:n}=await je(l[0]);ye({src:e,remote:t,title:l[0].name,kind:"base",fileKey:n})}catch(n){y.error(Ce(n))}finally{le.value=!1,t&&(t.value="")}}else t.value=""},Ee=e=>{const t=re.value;if(!t)return;const l=ue.value+e;l>=1&&l<=ve.value&&(ce[t.id]=l)},Ae=async()=>{var t,l;const n=ee.value.trim();if(!n&&!oe.value.length)return void y.warning("请输入内容或选择参考图");if(te.value)return;te.value=!0;const a=oe.value.map((e=>({...e})));try{await xe(a),n&&fe({id:crypto.randomUUID(),role:"user",type:"text",content:n}),a.forEach((e=>{fe({id:crypto.randomUUID(),role:"user",type:"image",content:e.src})}));const o={prompt:n||"根据当前参考图片生成海报",references:a.filter((e=>"reference"===e.kind)).map((e=>e.remote)),base_images:a.filter((e=>"base"===e.kind)).map((e=>e.ossUrl||e.remote))},s=await(t=>e("api/poster/tasks",t,"post",{},{timeout:18e4}))(o);if(0!==s.code&&200!==s.code)throw new Error(s.message||"任务创建失败");const i=(null==(t=s.data)?void 0:t.image_urls)||s.image_urls;if(null==i?void 0:i.length)return fe({id:crypto.randomUUID(),role:"ai",type:"text",content:"生成完成，已返回预览。"}),i.forEach((e=>fe({id:crypto.randomUUID(),role:"ai",type:"image",content:e}))),te.value=!1,void(oe.value=[]);const d=null==(l=s.data)?void 0:l.task_id;if(!d)throw new Error("任务ID缺失");const c=fe({id:crypto.randomUUID(),role:"ai",type:"text",content:"已提交生成任务，正在排队…"});Ue(d,c)}catch(o){te.value=!1,y.error(Ce(o))}finally{ee.value=""}},je=async t=>{const l=new FormData;l.append("file",t);const n=await e("api/files/upload",l,"post");if(!n||"success"!==n.status||!n.file_path)throw new Error((null==n?void 0:n.message)||"上传失败");return{preview:await Be(t),remote:`${U}/api/files/${n.file_path}`,fileKey:n.file_path}},_e={in_queue:"排队中",generating:"生成中",processing:"生成中",running:"生成中",pending:"排队中"},ke=()=>{se.value&&(window.clearTimeout(se.value),se.value=null)},Ue=(t,l)=>{ke();const n=async()=>{var a,o;try{const s=await(t=>e(`api/poster/tasks/${t}`,{},"get"))(t);if(0!==s.code)throw new Error(s.message||"查询失败");const i=(null==(a=s.data)?void 0:a.status)||"unknown";if(["done","success","finished"].includes(i)){me(l,"生成完成，已返回预览。");const e=(null==(o=s.data)?void 0:o.image_urls)||[];return e.length?e.forEach((e=>{fe({id:crypto.randomUUID(),role:"ai",type:"image",content:e})})):fe({id:crypto.randomUUID(),role:"ai",type:"text",content:"任务完成，但暂未获取到图片。"}),te.value=!1,oe.value=[],void ke()}if(["failed","error","timeout"].includes(i))return me(l,"生成失败，请稍后重试。"),te.value=!1,void ke();me(l,`任务${_e[i]||i}，请稍候…`),se.value=window.setTimeout(n,5e3)}catch(s){me(l,`查询失败：${Ce(s)}`),te.value=!1,ke()}};n()},Be=e=>new Promise(((t,l)=>{const n=new FileReader;n.onload=()=>t(n.result),n.onerror=l,n.readAsDataURL(e)})),Ce=e=>e instanceof Error?e.message:String(e),xe=async t=>{const l=t.filter((e=>"base"===e.kind&&!e.ossUrl&&e.fileKey));if(l.length)for(const n of l){const t=await e("api/files/upload-oss",{file_path:n.fileKey,remote_path:"poster/base"},"post");if(!t||"success"!==t.status||!t.oss_url)throw new Error((null==t?void 0:t.message)||"OSS上传失败");n.ossUrl=t.oss_url;const l=oe.value.find((e=>e.id===n.id));l&&(l.ossUrl=t.oss_url)}};return o((()=>{ke()})),(e,t)=>{const l=p("el-button"),n=p("el-tab-pane"),a=p("el-tabs"),o=p("el-icon"),y=p("el-input"),g=p("el-tooltip");return i(),s("div",D,[d("aside",$,[R,V,d("div",K,[r(" 引用区："+u(oe.value.length)+"/"+u(2)+" ",1),d("span",null,"引用+底图最多 "+u(2)+" 张")]),c(a,{modelValue:de.value,"onUpdate:modelValue":t[2]||(t[2]=e=>de.value=e),class:"poster-tabs"},{default:v((()=>[(i(!0),s(b,null,f(ie,(e=>(i(),h(n,{key:e.id,name:e.id,label:e.name},{default:v((()=>[d("div",P,[(i(!0),s(b,null,f(pe.value,(e=>(i(),s("div",{key:e.id,class:m(["example-card",{disabled:!be.value}]),title:be.value?"点击引用该模板":"最多只能添加两张图片",onClick:t=>(e=>{we()&&ye({src:e.cover,remote:e.cover,title:e.title,kind:"reference"})})(e)},[d("img",{src:e.cover,alt:e.title},null,8,L),d("p",null,u(e.title),1)],10,q)))),128))]),ve.value>1?(i(),s("div",z,[c(l,{size:"small",onClick:t[0]||(t[0]=e=>Ee(-1)),disabled:ue.value<=1},{default:v((()=>[r("上一页")])),_:1},8,["disabled"]),d("span",null,u(ue.value)+" / "+u(ve.value),1),c(l,{size:"small",onClick:t[1]||(t[1]=e=>Ee(1)),disabled:ue.value>=ve.value},{default:v((()=>[r("下一页")])),_:1},8,["disabled"])])):E("",!0)])),_:2},1032,["name","label"])))),128))])),_:1},8,["modelValue"])]),d("section",O,[d("div",{ref_key:"messageContainer",ref:ae,class:"messages"},[(i(!0),s(b,null,f(I,(e=>(i(),s("div",{key:e.id,class:m(["message",e.role])},[d("div",S,["text"===e.type?(i(),s(b,{key:0},[r(u(e.content),1)],64)):(i(),s("img",{key:1,src:e.content,alt:"chat image"},null,8,T))])],2)))),128))],512),d("div",F,[d("div",M,[d("div",null,[r("引用区 "),d("span",Y,u(oe.value.length)+"/"+u(2),1)]),G]),oe.value.length?(i(),s("div",H,[(i(!0),s(b,null,f(oe.value,(e=>(i(),s("div",{class:"reference-chip",key:e.id},[d("img",{src:e.src,alt:"reference"},null,8,Q),d("div",W,[d("span",{class:m(["chip-label",e.kind])},u("reference"===e.kind?"引用":"底图"),3),d("span",X,u(e.title||"未命名图片"),1)]),c(o,{class:"chip-close",onClick:w((t=>{return l=e.id,void(oe.value=oe.value.filter((e=>e.id!==l)));var l}),["stop"])},{default:v((()=>[c(A(j))])),_:2},1032,["onClick"])])))),128))])):(i(),s("p",Z,"从左侧模板或上传底图添加图片（最多两张）。"))]),d("div",J,[c(y,{modelValue:ee.value,"onUpdate:modelValue":t[3]||(t[3]=e=>ee.value=e),type:"textarea",autosize:{minRows:2,maxRows:4},placeholder:"描述你想要的海报或提出问题"},null,8,["modelValue"]),d("div",N,[d("input",{ref_key:"imageInput",ref:ne,class:"hidden-input",type:"file",accept:"image/*",onChange:he},null,544),c(g,{content:"上传底图",placement:"top"},{default:v((()=>[c(l,{circle:"",text:"",class:"icon-button",loading:le.value,disabled:le.value||!be.value,onClick:ge},{default:v((()=>[c(o,null,{default:v((()=>[c(A(_))])),_:1})])),_:1},8,["loading","disabled"])])),_:1}),c(l,{type:"primary",onClick:Ae,loading:te.value,disabled:te.value||!ee.value&&!oe.value.length},{default:v((()=>[r(" 发送 ")])),_:1},8,["loading","disabled"])])])])])}}}),[["__scopeId","data-v-77bfbfb6"]]);export{ee as default};
