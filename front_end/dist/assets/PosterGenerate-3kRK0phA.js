import{co as e,j as a,bY as l,r as t,c as s,o as i,a as n,p as o,s as r,v as c,A as u,Y as d,W as v,B as p,bZ as f,Q as m,X as g,y,ab as h,cp as w,cd as b,O as k,a9 as _,q as U,cu as x,u as I,c8 as C,cq as D,c3 as E,c4 as R,bO as $,ac as A}from"./index-C41rojVR.js";const V=e=>(E("data-v-ce7e6d52"),e=e(),R(),e),K={class:"poster-generate"},P={class:"side-panel"},q=V((()=>c("h2",null,"海报生成助手",-1))),z=V((()=>c("p",{class:"desc"},"选择参考模板或上传图片，帮助 AI 更好理解你的需求。",-1))),L={class:"quota-tip"},S={class:"example-grid"},T=["title","onClick"],O=["src","alt"],j={key:0,class:"pagination"},F={class:"chat-panel"},M={class:"bubble"},Y=["src"],B={class:"reference-strip"},G={class:"strip-head"},H={class:"count"},Q=V((()=>c("span",{class:"strip-note"},"引用来自模板，底图来自上传",-1))),W={key:0,class:"reference-list"},X=["src"],Z={class:"chip-info"},J={class:"chip-title"},N={key:1,class:"reference-empty"},ee={class:"chat-input"},ae={class:"chat-actions"},le=A(a({__name:"PosterGenerate",setup(a){const E=(b.API_URL&&b.API_URL.trim().length?b.API_URL:"undefined"!=typeof window?window.location.origin:"").replace(/\/$/,""),R=l([{id:crypto.randomUUID(),role:"ai",type:"text",content:"你好，我是海报生成助手。告诉我你的想法或上传参考图，我会给出建议。"}]),A=t(""),V=t(!1),le=t(!1),te=t(null),se=t(null),ie=t([]),ne=t(null),oe=t([]),re=t(""),ce=l({}),ue=l({}),de=l({}),ve=t([]),pe=t(!1),fe=s((()=>oe.value.find((e=>e.id===re.value)))),me=s((()=>fe.value&&ce[fe.value.id]||1)),ge=s((()=>{const e=fe.value;if(!e)return 1;const a=ue[e.id]??20;return Math.max(1,Math.ceil(a/20))})),ye=s((()=>ve.value)),he=s((()=>ie.value.length<2)),we=e=>{ce[e]||(ce[e]=1)},be=async(a,l)=>{var t,s,i;if(a)if(we(a),null==(t=de[a])?void 0:t[l])ve.value=de[a][l];else{pe.value=!0;try{const t=await(n={category_id:a,page:l,pageSize:20},e("api/poster-data/examples",n,"get")),o=(null==(s=t.result)?void 0:s.list)||[],r=(null==(i=t.result)?void 0:i.total)||0;ue[a]=r,de[a]=de[a]||{},de[a][l]=o,ve.value=o}catch(o){w.error(ze(o))}finally{pe.value=!1}var n}},ke=async()=>{try{const a=await e("api/poster-data/categories",{},"get");oe.value=a.result||[],oe.value.length&&(re.value=oe.value[0].id,oe.value.forEach((e=>we(e.id))),await be(re.value,ce[re.value]))}catch(a){w.error(`加载海报参考失败：${ze(a)}`)}};i((()=>{ke()}));const _e=e=>(R.push(e),$((()=>{var e;null==(e=se.value)||e.scrollTo({top:se.value.scrollHeight,behavior:"smooth"})})),e.id),Ue=(e,a)=>{const l=R.find((a=>a.id===e));l&&(l.content=a)},xe=()=>!!he.value||(w.warning("引用区最多只能放 2 张图片"),!1),Ie=e=>{ie.value.unshift({...e,id:crypto.randomUUID()})},Ce=()=>{var e;xe()&&(null==(e=te.value)||e.click())},De=async e=>{const a=e.target,l=null==a?void 0:a.files;if(l&&l[0])if(xe()){le.value=!0;try{const{preview:e,remote:a,fileKey:t}=await Ae(l[0]);Ie({src:e,remote:a,title:l[0].name,kind:"base",fileKey:t})}catch(t){w.error(ze(t))}finally{le.value=!1,a&&(a.value="")}}else a.value=""},Ee=e=>{const a=fe.value;if(!a)return;const l=me.value+e;l>=1&&l<=ge.value&&(ce[a.id]=l,be(a.id,l))},Re=e=>{e&&(we(e),be(e,ce[e]))},$e=async()=>{var a;const l=A.value.trim();if(!l&&!ie.value.length)return void w.warning("请输入内容或选择参考图");if(V.value)return;V.value=!0;const t=ie.value.map((e=>({...e})));try{await Le(t),l&&_e({id:crypto.randomUUID(),role:"user",type:"text",content:l}),t.forEach((e=>{_e({id:crypto.randomUUID(),role:"user",type:"image",content:e.src})}));const s={prompt:l||"根据当前参考图片生成海报",references:t.filter((e=>"reference"===e.kind)).map((e=>e.remote)),base_images:t.filter((e=>"base"===e.kind)).map((e=>e.ossUrl||e.remote))},i=await(a=>e("api/poster/tasks",a,"post",{},{timeout:18e4}))(s);if(0!==i.code)throw new Error(i.message||"任务创建失败");const n=null==(a=i.data)?void 0:a.task_id;if(!n)throw new Error("任务ID缺失");const o=_e({id:crypto.randomUUID(),role:"ai",type:"text",content:"已提交生成任务，正在排队…"});Pe(n,o)}catch(s){V.value=!1,w.error(ze(s))}finally{A.value=""}},Ae=async a=>{const l=new FormData;l.append("file",a);const t=await e("api/files/upload",l,"post");if(!t||"success"!==t.status||!t.file_path)throw new Error((null==t?void 0:t.message)||"上传失败");return{preview:await qe(a),remote:`${E}/api/files/${t.file_path}`,fileKey:t.file_path}},Ve={in_queue:"排队中",generating:"生成中",processing:"生成中",running:"生成中",pending:"排队中"},Ke=()=>{ne.value&&(window.clearTimeout(ne.value),ne.value=null)},Pe=(a,l)=>{Ke();const t=async()=>{var s,i;try{const n=await(a=>e(`api/poster/tasks/${a}`,{},"get"))(a);if(0!==n.code)throw new Error(n.message||"查询失败");const o=(null==(s=n.data)?void 0:s.status)||"unknown";if(["done","success","finished"].includes(o)){Ue(l,"生成完成，已返回预览。");const e=(null==(i=n.data)?void 0:i.image_urls)||[];return e.length?e.forEach((e=>{_e({id:crypto.randomUUID(),role:"ai",type:"image",content:e})})):_e({id:crypto.randomUUID(),role:"ai",type:"text",content:"任务完成，但暂未获取到图片。"}),V.value=!1,void Ke()}if(["failed","error","timeout"].includes(o))return Ue(l,"生成失败，请稍后重试。"),V.value=!1,void Ke();Ue(l,`任务${Ve[o]||o}，请稍候…`),ne.value=window.setTimeout(t,5e3)}catch(n){Ue(l,`查询失败：${ze(n)}`),V.value=!1,Ke()}};t()},qe=e=>new Promise(((a,l)=>{const t=new FileReader;t.onload=()=>a(t.result),t.onerror=l,t.readAsDataURL(e)})),ze=e=>e instanceof Error?e.message:String(e),Le=async a=>{const l=a.filter((e=>"base"===e.kind&&!e.ossUrl&&e.fileKey));if(l.length)for(const t of l){const a=await e("api/files/upload-oss",{file_path:t.fileKey,remote_path:"poster/base"},"post");if(!a||"success"!==a.status||!a.oss_url)throw new Error((null==a?void 0:a.message)||"OSS上传失败");t.ossUrl=a.oss_url;const l=ie.value.find((e=>e.id===t.id));l&&(l.ossUrl=a.oss_url)}};return n((()=>{Ke()})),(e,a)=>{const l=f("el-button"),t=f("el-tab-pane"),s=f("el-tabs"),i=f("el-icon"),n=f("el-input"),w=f("el-tooltip"),b=x("loading");return r(),o("div",K,[c("aside",P,[q,z,c("div",L,[d(" 引用区："+v(ie.value.length)+"/"+v(2)+" ",1),c("span",null,"引用+底图最多 "+v(2)+" 张")]),u(s,{modelValue:re.value,"onUpdate:modelValue":a[2]||(a[2]=e=>re.value=e),class:"poster-tabs",onTabChange:Re},{default:p((()=>[(r(!0),o(m,null,g(oe.value,(e=>(r(),k(t,{key:e.id,name:e.id,label:e.name},{default:p((()=>[_((r(),o("div",S,[(r(!0),o(m,null,g(ye.value,(e=>(r(),o("div",{key:e.id,class:y(["example-card",{disabled:!he.value}]),title:he.value?"点击引用该模板":"最多只能添加两张图片",onClick:a=>(e=>{xe()&&Ie({src:e.cover,remote:e.cover,title:e.title,kind:"reference"})})(e)},[c("img",{src:e.cover,alt:e.title},null,8,O),c("p",null,v(e.title),1)],10,T)))),128))])),[[b,pe.value]]),ge.value>1?(r(),o("div",j,[u(l,{size:"small",onClick:a[0]||(a[0]=e=>Ee(-1)),disabled:me.value<=1},{default:p((()=>[d("上一页")])),_:1},8,["disabled"]),c("span",null,v(me.value)+" / "+v(ge.value),1),u(l,{size:"small",onClick:a[1]||(a[1]=e=>Ee(1)),disabled:me.value>=ge.value},{default:p((()=>[d("下一页")])),_:1},8,["disabled"])])):U("",!0)])),_:2},1032,["name","label"])))),128))])),_:1},8,["modelValue"])]),c("section",F,[c("div",{ref_key:"messageContainer",ref:se,class:"messages"},[(r(!0),o(m,null,g(R,(e=>(r(),o("div",{key:e.id,class:y(["message",e.role])},[c("div",M,["text"===e.type?(r(),o(m,{key:0},[d(v(e.content),1)],64)):(r(),o("img",{key:1,src:e.content,alt:"chat image"},null,8,Y))])],2)))),128))],512),c("div",B,[c("div",G,[c("div",null,[d("引用区 "),c("span",H,v(ie.value.length)+"/"+v(2),1)]),Q]),ie.value.length?(r(),o("div",W,[(r(!0),o(m,null,g(ie.value,(e=>(r(),o("div",{class:"reference-chip",key:e.id},[c("img",{src:e.src,alt:"reference"},null,8,X),c("div",Z,[c("span",{class:y(["chip-label",e.kind])},v("reference"===e.kind?"引用":"底图"),3),c("span",J,v(e.title||"未命名图片"),1)]),u(i,{class:"chip-close",onClick:h((a=>{return l=e.id,void(ie.value=ie.value.filter((e=>e.id!==l)));var l}),["stop"])},{default:p((()=>[u(I(C))])),_:2},1032,["onClick"])])))),128))])):(r(),o("p",N,"从左侧模板或上传底图添加图片（最多两张）。"))]),c("div",ee,[u(n,{modelValue:A.value,"onUpdate:modelValue":a[3]||(a[3]=e=>A.value=e),type:"textarea",autosize:{minRows:2,maxRows:4},placeholder:"描述你想要的海报或提出问题"},null,8,["modelValue"]),c("div",ae,[c("input",{ref_key:"imageInput",ref:te,class:"hidden-input",type:"file",accept:"image/*",onChange:De},null,544),u(w,{content:"上传底图",placement:"top"},{default:p((()=>[u(l,{circle:"",text:"",class:"icon-button",loading:le.value,disabled:le.value||!he.value,onClick:Ce},{default:p((()=>[u(i,null,{default:p((()=>[u(I(D))])),_:1})])),_:1},8,["loading","disabled"])])),_:1}),u(l,{type:"primary",onClick:$e,loading:V.value,disabled:V.value||!A.value&&!ie.value.length},{default:p((()=>[d(" 发送 ")])),_:1},8,["loading","disabled"])])])])])}}}),[["__scopeId","data-v-ce7e6d52"]]);export{le as default};
