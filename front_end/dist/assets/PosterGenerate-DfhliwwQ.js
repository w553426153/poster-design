import{co as e,j as t,bY as l,r as a,c as n,a5 as o,a as s,p as i,s as c,v as d,A as r,Y as u,W as p,B as v,bZ as b,Q as m,X as f,y as w,ab as h,cp as y,cd as g,O as E,q as A,u as k,c8 as j,cq as _,c3 as U,c4 as B,c0 as C,bT as x,bO as I,ac as D}from"./index-DIgVOHJd.js";const R=[{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%202.webp",type:"产品类",title:"产品 2"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%2014.webp",type:"产品类",title:"产品 14"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%2018.webp",type:"产品类",title:"产品 18"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E5%93%81%E7%89%8C%201.webp",type:"品牌类",title:"品牌 1"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%2019.webp",type:"产品类",title:"产品 19"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%2015.webp",type:"产品类",title:"产品 15"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%203.webp",type:"产品类",title:"产品 3"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%208.webp",type:"产品类",title:"产品 8"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E8%8A%82%E6%B0%94%201.webp",type:"节气类",title:"节气 1"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E5%93%81%E7%89%8C%207.webp",type:"品牌类",title:"品牌 7"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%204.webp",type:"产品类",title:"产品 4"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%2012.webp",type:"产品类",title:"产品 12"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%2013.webp",type:"产品类",title:"产品 13"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%205.webp",type:"产品类",title:"产品 5"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E5%93%81%E7%89%8C%206.webp",type:"品牌类",title:"品牌 6"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%209.webp",type:"产品类",title:"产品 9"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E5%93%81%E7%89%8C%205.webp",type:"品牌类",title:"品牌 5"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E8%8A%82%E6%B0%94%203.webp",type:"节气类",title:"节气 3"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E5%93%81%E7%89%8C%209.webp",type:"品牌类",title:"品牌 9"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%2010.webp",type:"产品类",title:"产品 10"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%206.webp",type:"产品类",title:"产品 6"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%207.webp",type:"产品类",title:"产品 7"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%2011.webp",type:"产品类",title:"产品 11"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E5%93%81%E7%89%8C%208.webp",type:"品牌类",title:"品牌 8"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E8%8A%82%E6%B0%94%202.webp",type:"节气类",title:"节气 2"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E5%93%81%E7%89%8C%204.webp",type:"品牌类",title:"品牌 4"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%2016.webp",type:"产品类",title:"产品 16"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E5%93%81%E7%89%8C%203.webp",type:"品牌类",title:"品牌 3"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E8%8A%82%E6%B0%94%204.webp",type:"节气类",title:"节气 4"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E5%93%81%E7%89%8C%202.webp",type:"品牌类",title:"品牌 2"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%201.webp",type:"产品类",title:"产品 1"},{url:"https://ennova-bigdata-test.obsv3.cn-lflt-1.enncloud.cn/video/model/wj/%E4%BA%A7%E5%93%81%2017.webp",type:"产品类",title:"产品 17"}],$=e=>(U("data-v-f42f9f01"),e=e(),B(),e),L={class:"poster-generate"},O={class:"side-panel"},V=$((()=>d("h2",null,"海报生成助手",-1))),z=$((()=>d("p",{class:"desc"},"选择参考模板或上传图片，帮助 AI 更好理解你的需求。",-1))),K={class:"quota-tip"},P={class:"example-grid"},S=["title","onClick"],q=["src","alt"],T={key:0,class:"pagination"},H={class:"chat-panel"},F={class:"bubble"},J=["src"],M={class:"img-actions"},N={class:"reference-strip"},W={class:"strip-head"},Y={class:"count"},G=$((()=>d("span",{class:"strip-note"},"引用来自模板，底图来自上传",-1))),Q={key:0,class:"reference-list"},X=["src"],Z={class:"chip-info"},ee={class:"chip-title"},te={key:1,class:"reference-empty"},le={class:"chat-input"},ae={class:"chat-actions"},ne=D(t({__name:"PosterGenerate",setup(t){var U;const B=(g.API_URL&&g.API_URL.trim().length?g.API_URL:"undefined"!=typeof window?window.location.origin:"").replace(/\/$/,""),D=["产品类","品牌类","节气类"],$=l([{id:crypto.randomUUID(),role:"ai",type:"text",content:"你好，我是海报生成助手。告诉我你的想法或上传参考图，我会给出建议。"}]),ne=a(""),oe=a(!1),se=a(!1),ie=a(null),ce=a(null),de=a([]),re=a(null),ue=l((()=>{const e={"产品类":[],"品牌类":[],"节气类":[]};return R.forEach(((t,l)=>{e[t.type]&&e[t.type].push({id:`${t.type}-${l}`,title:t.title,cover:t.url})})),D.map((t=>({id:t,name:t,examples:e[t]||[]})))})()),pe=a((null==(U=ue[0])?void 0:U.id)||"产品类"),ve=l({});ue.forEach((e=>ve[e.id]=1));const be=n((()=>ue.find((e=>e.id===pe.value)))),me=n((()=>be.value?ve[be.value.id]:1)),fe=n((()=>{var e;const t=(null==(e=be.value)?void 0:e.examples)||[];return Math.max(1,Math.ceil(t.length/20))})),we=n((()=>{const e=be.value;if(!e)return[];const t=20*(me.value-1);return e.examples.slice(t,t+20)})),he=n((()=>de.value.length<2)),ye=C(),ge=o(),Ee=e=>($.push(e),I((()=>{var e;null==(e=ce.value)||e.scrollTo({top:ce.value.scrollHeight,behavior:"smooth"})})),e.id),Ae=(e,t)=>{const l=$.find((t=>t.id===e));l&&(l.content=t)},ke=()=>!!he.value||(y.warning("引用区最多只能放 2 张图片"),!1),je=e=>{de.value.unshift({...e,id:crypto.randomUUID()})},_e=()=>{var e;ke()&&(null==(e=ie.value)||e.click())},Ue=async e=>{const t=e.target,l=null==t?void 0:t.files;if(l&&l[0])if(ke()){se.value=!0;try{const{preview:e,remote:t,fileKey:a}=await xe(l[0]);je({src:e,remote:t,title:l[0].name,kind:"base",fileKey:a})}catch(a){y.error(Le(a))}finally{se.value=!1,t&&(t.value="")}}else t.value=""},Be=e=>{const t=be.value;if(!t)return;const l=me.value+e;l>=1&&l<=fe.value&&(ve[t.id]=l)},Ce=async()=>{var t,l;const a=ne.value.trim();if(!a&&!de.value.length)return void y.warning("请输入内容或选择参考图");if(oe.value)return;oe.value=!0;const n=de.value.map((e=>({...e})));try{await Oe(n),a&&Ee({id:crypto.randomUUID(),role:"user",type:"text",content:a}),n.forEach((e=>{Ee({id:crypto.randomUUID(),role:"user",type:"image",content:e.src})}));const o={prompt:a||"根据当前参考图片生成海报",references:n.filter((e=>"reference"===e.kind)).map((e=>e.remote)),base_images:n.filter((e=>"base"===e.kind)).map((e=>e.ossUrl||e.remote))},s=await(t=>e("api/poster/tasks",t,"post",{},{timeout:18e4}))(o);if(!(0===s.code||200===s.code||1===s.stat))throw new Error(s.message||"任务创建失败");const i=(null==(t=s.data)?void 0:t.image_urls)||s.image_urls;if(null==i?void 0:i.length)return Ee({id:crypto.randomUUID(),role:"ai",type:"text",content:"生成完成，已返回预览。"}),i.forEach((e=>Ee({id:crypto.randomUUID(),role:"ai",type:"image",content:e}))),oe.value=!1,void(de.value=[]);const c=null==(l=s.data)?void 0:l.task_id;if(!c)throw new Error("任务ID缺失");const d=Ee({id:crypto.randomUUID(),role:"ai",type:"text",content:"已提交生成任务，正在排队…"});Re(c,d)}catch(o){oe.value=!1,y.error(Le(o))}finally{ne.value=""}},xe=async t=>{const l=new FormData;l.append("file",t);const a=await e("api/files/upload",l,"post");if(!a||"success"!==a.status||!a.file_path)throw new Error((null==a?void 0:a.message)||"上传失败");return{preview:await $e(t),remote:`${B}/api/files/${a.file_path}`,fileKey:a.file_path}},Ie={in_queue:"排队中",generating:"生成中",processing:"生成中",running:"生成中",pending:"排队中"},De=()=>{re.value&&(window.clearTimeout(re.value),re.value=null)},Re=(t,l)=>{De();const a=async()=>{var n,o;try{const s=await(t=>e(`api/poster/tasks/${t}`,{},"get"))(t);if(0!==s.code)throw new Error(s.message||"查询失败");const i=(null==(n=s.data)?void 0:n.status)||"unknown";if(["done","success","finished"].includes(i)){Ae(l,"生成完成，已返回预览。");const e=(null==(o=s.data)?void 0:o.image_urls)||[];return e.length?e.forEach((e=>{Ee({id:crypto.randomUUID(),role:"ai",type:"image",content:e})})):Ee({id:crypto.randomUUID(),role:"ai",type:"text",content:"任务完成，但暂未获取到图片。"}),oe.value=!1,de.value=[],void De()}if(["failed","error","timeout"].includes(i))return Ae(l,"生成失败，请稍后重试。"),oe.value=!1,void De();Ae(l,`任务${Ie[i]||i}，请稍候…`),re.value=window.setTimeout(a,5e3)}catch(s){Ae(l,`查询失败：${Le(s)}`),oe.value=!1,De()}};a()},$e=e=>new Promise(((t,l)=>{const a=new FileReader;a.onload=()=>t(a.result),a.onerror=l,a.readAsDataURL(e)})),Le=e=>e instanceof Error?e.message:String(e),Oe=async t=>{const l=t.filter((e=>"base"===e.kind&&!e.ossUrl&&e.fileKey));if(l.length)for(const a of l){const t=await e("api/files/upload-oss",{file_path:a.fileKey,remote_path:"poster/base"},"post");if(!t||"success"!==t.status||!t.oss_url)throw new Error((null==t?void 0:t.message)||"OSS上传失败");a.ossUrl=t.oss_url;const l=de.value.find((e=>e.id===a.id));l&&(l.ossUrl=t.oss_url)}};return s((()=>{De()})),(e,t)=>{const l=b("el-button"),a=b("el-tab-pane"),n=b("el-tabs"),o=b("el-icon"),s=b("el-input"),g=b("el-tooltip");return c(),i("div",L,[d("aside",O,[V,z,d("div",K,[u(" 引用区："+p(de.value.length)+"/"+p(2)+" ",1),d("span",null,"引用+底图最多 "+p(2)+" 张")]),r(n,{modelValue:pe.value,"onUpdate:modelValue":t[2]||(t[2]=e=>pe.value=e),class:"poster-tabs"},{default:v((()=>[(c(!0),i(m,null,f(ue,(e=>(c(),E(a,{key:e.id,name:e.id,label:e.name},{default:v((()=>[d("div",P,[(c(!0),i(m,null,f(we.value,(e=>(c(),i("div",{key:e.id,class:w(["example-card",{disabled:!he.value}]),title:he.value?"点击引用该模板":"最多只能添加两张图片",onClick:t=>(e=>{ke()&&je({src:e.cover,remote:e.cover,title:e.title,kind:"reference"})})(e)},[d("img",{src:e.cover,alt:e.title},null,8,q),d("p",null,p(e.title),1)],10,S)))),128))]),fe.value>1?(c(),i("div",T,[r(l,{size:"small",onClick:t[0]||(t[0]=e=>Be(-1)),disabled:me.value<=1},{default:v((()=>[u("上一页")])),_:1},8,["disabled"]),d("span",null,p(me.value)+" / "+p(fe.value),1),r(l,{size:"small",onClick:t[1]||(t[1]=e=>Be(1)),disabled:me.value>=fe.value},{default:v((()=>[u("下一页")])),_:1},8,["disabled"])])):A("",!0)])),_:2},1032,["name","label"])))),128))])),_:1},8,["modelValue"])]),d("section",H,[d("div",{ref_key:"messageContainer",ref:ce,class:"messages"},[(c(!0),i(m,null,f($,(e=>(c(),i("div",{key:e.id,class:w(["message",e.role])},[d("div",F,["text"===e.type?(c(),i(m,{key:0},[u(p(e.content),1)],64)):(c(),i(m,{key:1},[d("img",{src:e.content,alt:"chat image"},null,8,J),d("div",M,[r(l,{text:"",size:"small",onClick:t=>(async e=>{try{const t=await fetch(e),l=await t.blob(),a=document.createElement("a");a.href=URL.createObjectURL(l),a.download=`poster-${Date.now()}.png`,a.click(),URL.revokeObjectURL(a.href)}catch(t){y.error(Le(t))}})(e.content)},{default:v((()=>[u("下载")])),_:2},1032,["onClick"]),r(l,{text:"",type:"primary",size:"small",onClick:t=>(async e=>{"Home"!==ye.currentRoute.value.name&&ye.push({name:"Home"});const t=new Image;t.crossOrigin="anonymous",t.src=e,t.onload=()=>{const l=JSON.parse(JSON.stringify(x));l.url=e,l.width=t.width,l.height=t.height,ge.addWidget(l),y.success("已添加到画布")},t.onerror=()=>y.error("加载图片失败")})(e.content)},{default:v((()=>[u("添加到画布")])),_:2},1032,["onClick"])])],64))])],2)))),128))],512),d("div",N,[d("div",W,[d("div",null,[u("引用区 "),d("span",Y,p(de.value.length)+"/"+p(2),1)]),G]),de.value.length?(c(),i("div",Q,[(c(!0),i(m,null,f(de.value,(e=>(c(),i("div",{class:"reference-chip",key:e.id},[d("img",{src:e.src,alt:"reference"},null,8,X),d("div",Z,[d("span",{class:w(["chip-label",e.kind])},p("reference"===e.kind?"引用":"底图"),3),d("span",ee,p(e.title||"未命名图片"),1)]),r(o,{class:"chip-close",onClick:h((t=>{return l=e.id,void(de.value=de.value.filter((e=>e.id!==l)));var l}),["stop"])},{default:v((()=>[r(k(j))])),_:2},1032,["onClick"])])))),128))])):(c(),i("p",te,"从左侧模板或上传底图添加图片（最多两张）。"))]),d("div",le,[r(s,{modelValue:ne.value,"onUpdate:modelValue":t[3]||(t[3]=e=>ne.value=e),type:"textarea",autosize:{minRows:2,maxRows:4},placeholder:"描述你想要的海报或提出问题"},null,8,["modelValue"]),d("div",ae,[d("input",{ref_key:"imageInput",ref:ie,class:"hidden-input",type:"file",accept:"image/*",onChange:Ue},null,544),r(g,{content:"上传底图",placement:"top"},{default:v((()=>[r(l,{circle:"",text:"",class:"icon-button",loading:se.value,disabled:se.value||!he.value,onClick:_e},{default:v((()=>[r(o,null,{default:v((()=>[r(k(_))])),_:1})])),_:1},8,["loading","disabled"])])),_:1}),r(l,{type:"primary",onClick:Ce,loading:oe.value,disabled:oe.value||!ne.value&&!de.value.length},{default:v((()=>[u(" 发送 ")])),_:1},8,["loading","disabled"])])])])])}}}),[["__scopeId","data-v-f42f9f01"]]);export{ne as default};
